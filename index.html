<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Passkey</title>
</head>
<body>
    <h1>Create a Passkey</h1>
    <button id="createPasskeyButton">Create Passkey</button>

    <script>
    let heapOverflowTriggered = false;
    let largeBuffer = null;

    // Function to create passkey and trigger heap overflow afterwards
    async function createPasskeyWithWasm() {
        try {
            console.log("Opening security key setup...");

            // Simulate a smaller challenge for the WebAuthn creation process
            const challengeData = new Uint8Array(64);  // Much smaller challenge, just for WebAuthn

            const publicKeyCredentialCreationOptions = {
                rp: {
                    name: "ProDev Hacker",
                    id: window.location.hostname
                },
                user: {
                    id: new Uint8Array([1, 2, 3, 4]),
                    name: "user@example.com",
                    displayName: "User Name"
                },
                pubKeyCredParams: [
                    { type: "public-key", alg: -7 },  // ES256
                    { type: "public-key", alg: -257 } // RS256
                ],
                timeout: 60000,
                challenge: challengeData,  // Pass a smaller challenge
                attestation: "none"
            };

            // Trigger passkey creation and wait for user interaction (OK or Cancel)
            const credential = await navigator.credentials.create({ publicKey: publicKeyCredentialCreationOptions });

            // After the user interacts with the popup (success or cancellation), continue
            console.log("Passkey created:", credential);

            // Now that the passkey creation process is finished, trigger the heap overflow
            triggerHeapOverflow();

        } catch (error) {
            // This will catch if the user cancels or if there's an error
            if (error.name === "AbortError") {
                console.log("User canceled the passkey creation.");
            } else {
                console.error("Error creating passkey:", error);
            }
        }
    }

    // Function to trigger heap buffer overflow after passkey creation popup is interacted with
    function triggerHeapOverflow() {
        if (!heapOverflowTriggered) {
            heapOverflowTriggered = true;
            console.log("Heap buffer overflow occurred");

            // Simulate a large buffer allocation
            try {
                largeBuffer = new Uint8Array(1024 * 1024 * 100);  // 100 MB array for simulation
                console.log("Large buffer allocated to simulate heap overflow.");
                
                // Here, we'll replace the large buffer with a smaller one to "clear" the memory
                setTimeout(() => {
                    console.log("Clearing memory...");
                    largeBuffer = null;  // Clear the large buffer (deallocate it)
                    console.log("Memory cleared and replaced with null.");
                    
                    // Replace the large buffer with a smaller, manageable one
                    largeBuffer = new Uint8Array(64);  // Just a small buffer to avoid memory issues
                    console.log("Memory replaced with smaller buffer.");
                }, 1000);  // Wait a second to simulate the delay before clearing memory
            } catch (error) {
                console.error("Heap overflow simulation failed:", error);
            }
        }
    }

    // Event listener for the "Create Passkey" button
    document.getElementById('createPasskeyButton').addEventListener('click', createPasskeyWithWasm);
    </script>
</body>
</html>
